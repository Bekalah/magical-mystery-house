<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonic Physics Engine | Cathedral Professional Audio-Physics Integration</title>
    <style>
        /* Sonic Physics Cathedral Theme */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orpheus', 'Times New Roman', serif;
            background: linear-gradient(135deg, #0a0614 0%, #1a0f24 25%, #2a0f34 50%, #1a0f24 75%, #0a0614 100%);
            color: #e6e6fa;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Audio wave background */
        .audio-wave-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.1;
            z-index: -1;
        }

        /* Header with audio-physics theme */
        .header {
            background: linear-gradient(90deg, #2a0f34, #4a2064, #2a0f34);
            padding: 30px;
            text-align: center;
            border-bottom: 3px solid #e6e6fa;
            position: relative;
        }

        .header::before {
            content: '‚ô´';
            position: absolute;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2.5em;
            color: #e6e6fa;
            text-shadow: 0 0 20px rgba(230, 230, 250, 0.5);
        }

        .header::after {
            content: '‚öõ';
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2em;
            color: #9370db;
            text-shadow: 0 0 15px rgba(147, 112, 219, 0.5);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            color: #e6e6fa;
        }

        .header .subtitle {
            font-size: 1.2em;
            color: #9370db;
            font-style: italic;
            font-weight: 300;
        }

        .header .physics-quote {
            margin-top: 15px;
            font-size: 1em;
            color: #dda0dd;
            font-style: italic;
            border-top: 1px solid #e6e6fa;
            padding-top: 15px;
        }

        /* Main interface layout */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 25px;
            padding: 30px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Left Panel: Audio Synthesizers */
        .audio-panel {
            background: rgba(42, 15, 52, 0.9);
            border: 2px solid #9370db;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 0 30px rgba(147, 112, 219, 0.3);
        }

        .audio-panel h2 {
            color: #e6e6fa;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.6em;
        }

        .synthesizer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .synth-card {
            background: linear-gradient(135deg, rgba(147, 112, 219, 0.3), rgba(221, 160, 221, 0.2));
            border: 2px solid #9370db;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .synth-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(147, 112, 219, 0.4);
            border-color: #e6e6fa;
        }

        .synth-card.active {
            border-color: #e6e6fa;
            background: linear-gradient(135deg, rgba(230, 230, 250, 0.3), rgba(147, 112, 219, 0.4));
        }

        .synth-name {
            font-weight: bold;
            color: #e6e6fa;
            margin-bottom: 5px;
        }

        .synth-freq {
            font-size: 0.8em;
            color: #dda0dd;
        }

        /* Center Panel: Physics Simulation */
        .physics-panel {
            background: rgba(10, 20, 42, 0.9);
            border: 2px solid #4169e1;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 0 30px rgba(65, 105, 225, 0.3);
        }

        .physics-panel h2 {
            color: #e6e6fa;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.6em;
        }

        .physics-canvas {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #4169e1;
            border-radius: 10px;
            width: 100%;
            height: 300px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .physics-object {
            position: absolute;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.1s ease;
        }

        .physics-object:hover {
            transform: scale(1.1);
        }

        .physics-object.interacting {
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        .physics-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .control-group {
            background: rgba(65, 105, 225, 0.2);
            border-radius: 8px;
            padding: 15px;
        }

        .control-label {
            color: #e6e6fa;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .slider {
            width: 100%;
            margin: 8px 0;
        }

        /* Right Panel: Integration & Controls */
        .integration-panel {
            background: rgba(20, 42, 10, 0.9);
            border: 2px solid #32cd32;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 0 30px rgba(50, 205, 50, 0.3);
        }

        .integration-panel h2 {
            color: #e6e6fa;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.6em;
        }

        .hall-of-ateliers-connect {
            background: rgba(50, 205, 50, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #32cd32;
        }

        .workspace-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .workspace-btn {
            background: rgba(50, 205, 50, 0.3);
            border: 1px solid #32cd32;
            border-radius: 5px;
            padding: 10px;
            color: #e6e6fa;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .workspace-btn:hover {
            background: rgba(50, 205, 50, 0.5);
        }

        .workspace-btn.active {
            background: rgba(50, 205, 50, 0.7);
            border-color: #e6e6fa;
        }

        .real-time-monitor {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .monitor-display {
            font-family: 'Courier New', monospace;
            color: #32cd32;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .frequency-display {
            color: #ff69b4;
        }

        .physics-display {
            color: #00ffff;
        }

        /* Audio visualizer */
        .audio-visualizer {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .waveform-canvas {
            width: 100%;
            height: 60px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #9370db;
            border-radius: 5px;
        }

        /* Control buttons */
        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #9370db, #ba55d3);
            color: #ffffff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(147, 112, 219, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4169e1, #6495ed);
            color: #ffffff;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(65, 105, 225, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #32cd32, #00ff00);
            color: #000000;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(50, 205, 50, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff69b4, #ff1493);
            color: #ffffff;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 105, 180, 0.4);
        }

        /* Emergency exit */
        .emergency-exit {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(139, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            z-index: 1000;
            border: 1px solid #e6e6fa;
        }

        .emergency-exit:hover {
            background: rgba(139, 0, 0, 1);
            box-shadow: 0 0 10px rgba(230, 230, 250, 0.5);
        }

        /* Responsive design */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .synthesizer-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }

        /* Audio frequency visual effects */
        .frequency-bar {
            height: 4px;
            background: linear-gradient(90deg, #9370db, #ba55d3, #ff69b4, #00ffff);
            border-radius: 2px;
            margin: 2px 0;
            transition: width 0.1s ease;
        }

        .physics-sphere {
            background: radial-gradient(circle, rgba(65, 105, 225, 0.8), rgba(65, 105, 225, 0.2));
            border: 2px solid #4169e1;
        }

        .physics-sphere.large {
            width: 60px;
            height: 60px;
        }

        .physics-sphere.medium {
            width: 40px;
            height: 40px;
        }

        .physics-sphere.small {
            width: 25px;
            height: 25px;
        }
    </style>
</head>
<body>
    <!-- Emergency Exit -->
    <div class="emergency-exit" onclick="window.location.href='../../../hall-of-ateliers/cathedral_3d_hall_of_ateliers.py'">
        üèõÔ∏è ESC: Exit to Hall of Ateliers
    </div>

    <!-- Audio Wave Background -->
    <svg class="audio-wave-bg" viewBox="0 0 1000 1000">
        <defs>
            <linearGradient id="audioGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#9370db;stop-opacity:0.3" />
                <stop offset="50%" style="stop-color:#ba55d3;stop-opacity:0.3" />
                <stop offset="100%" style="stop-color:#ff69b4;stop-opacity:0.3" />
            </linearGradient>
        </defs>
        <path d="M 0 500 Q 250 300, 500 500 T 1000 500" stroke="url(#audioGradient)" stroke-width="3" fill="none" />
        <path d="M 0 400 Q 250 200, 500 400 T 1000 400" stroke="url(#audioGradient)" stroke-width="2" fill="none" />
        <path d="M 0 600 Q 250 400, 500 600 T 1000 600" stroke="url(#audioGradient)" stroke-width="2" fill="none" />
    </svg>

    <!-- Header -->
    <header class="header">
        <h1>Sonic Physics Engine</h1>
        <div class="subtitle">Real-Time Audio-Physics Binding for Professional Creative Spaces</div>
        <div class="physics-quote">"Sound is the foundation of all manifestation" - Hermetic Principle of Vibration</div>
    </header>

    <!-- Main Interface -->
    <div class="main-container">
        <!-- Left Panel: Audio Synthesizers -->
        <div class="audio-panel">
            <h2>üéµ Audio Synthesizers</h2>
            
            <div class="synthesizer-grid" id="synthGrid">
                <!-- Synthesizers will be populated by JavaScript -->
            </div>

            <div class="audio-visualizer">
                <h3 style="color: #e6e6fa; margin-bottom: 10px;">Audio Waveform</h3>
                <canvas class="waveform-canvas" id="waveformCanvas"></canvas>
            </div>
        </div>

        <!-- Center Panel: Physics Simulation -->
        <div class="physics-panel">
            <h2>‚öõÔ∏è Physics Simulation</h2>
            
            <div class="physics-canvas" id="physicsCanvas">
                <!-- Physics objects will be created dynamically -->
            </div>

            <div class="physics-controls">
                <div class="control-group">
                    <div class="control-label">Physics Parameters</div>
                    <label style="color: #e6e6fa; font-size: 0.9em;">Gravity:</label>
                    <input type="range" class="slider" id="gravitySlider" min="0" max="20" value="9.8" step="0.1">
                    <label style="color: #e6e6fa; font-size: 0.9em;">Bounciness:</label>
                    <input type="range" class="slider" id="bouncinessSlider" min="0" max="1" value="0.8" step="0.1">
                    <label style="color: #e6e6fa; font-size: 0.9em;">Friction:</label>
                    <input type="range" class="slider" id="frictionSlider" min="0" max="1" value="0.3" step="0.1">
                </div>

                <div class="control-group">
                    <div class="control-label">Audio-Physics Coupling</div>
                    <label style="color: #e6e6fa; font-size: 0.9em;">Volume ‚Üí Force:</label>
                    <input type="range" class="slider" id="volumeForceSlider" min="0" max="10" value="5" step="0.5">
                    <label style="color: #e6e6fa; font-size: 0.9em;">Frequency ‚Üí Mass:</label>
                    <input type="range" class="slider" id="freqMassSlider" min="0" max="10" value="3" step="0.5">
                    <label style="color: #e6e6fa; font-size: 0.9em;">Harmonics ‚Üí Rotation:</label>
                    <input type="range" class="slider" id="harmonicsRotationSlider" min="0" max="10" value="7" step="0.5">
                </div>
            </div>
        </div>

        <!-- Right Panel: Integration & Controls -->
        <div class="integration-panel">
            <h2>üèõÔ∏è Cathedral Integration</h2>
            
            <div class="hall-of-ateliers-connect">
                <h3 style="color: #e6e6fa; margin-bottom: 15px;">Connect to 3D Workspaces</h3>
                
                <div class="workspace-selector">
                    <div class="workspace-btn active" onclick="selectWorkspace('visual-artist', this)">
                        <div>üé® Visual Artist</div>
                        <div style="font-size: 0.8em; color: #32cd32;">528.0 Hz</div>
                    </div>
                    <div class="workspace-btn" onclick="selectWorkspace('mystic', this)">
                        <div>üîÆ Mystic</div>
                        <div style="font-size: 0.8em; color: #32cd32;">852.0 Hz</div>
                    </div>
                    <div class="workspace-btn" onclick="selectWorkspace('researcher', this)">
                        <div>üß™ Researcher</div>
                        <div style="font-size: 0.8em; color: #32cd32;">741.0 Hz</div>
                    </div>
                    <div class="workspace-btn" onclick="selectWorkspace('scholar', this)">
                        <div>üìö Scholar</div>
                        <div style="font-size: 0.8em; color: #32cd32;">741.0 Hz</div>
                    </div>
                    <div class="workspace-btn" onclick="selectWorkspace('designer', this)">
                        <div>üé≠ Designer</div>
                        <div style="font-size: 0.8em; color: #32cd32;">528.0 Hz</div>
                    </div>
                    <div class="workspace-btn" onclick="selectWorkspace('moonchild', this)">
                        <div>üåô Moonchild</div>
                        <div style="font-size: 0.8em; color: #32cd32;">288.0 Hz</div>
                    </div>
                </div>
            </div>

            <div class="real-time-monitor">
                <h3 style="color: #e6e6fa; margin-bottom: 10px;">Real-Time Monitor</h3>
                <div class="monitor-display" id="monitorDisplay">
                    <div>üéµ Frequency: <span class="frequency-display" id="currentFreq">432.0</span> Hz</div>
                    <div>‚öõÔ∏è Physics: <span class="physics-display" id="currentPhysics">Active</span></div>
                    <div>üèõÔ∏è Workspace: <span class="workspace-display" id="currentWorkspace">Visual Artist</span></div>
                    <div>üîä Audio Level: <span class="audio-display" id="currentAudio">0%</span></div>
                </div>
            </div>

            <div class="control-buttons">
                <button class="btn btn-primary" onclick="startSonicPhysics()">
                    Start Engine
                </button>
                <button class="btn btn-secondary" onclick="stopSonicPhysics()">
                    Stop Engine
                </button>
                <button class="btn btn-success" onclick="syncWithHallOfAteliers()">
                    Sync Ateliers
                </button>
                <button class="btn btn-warning" onclick="exportAudioPhysics()">
                    Export Data
                </button>
            </div>
        </div>
    </div>

    <script>
        // Professional Synthesizers with Sacred Frequencies
        const professionalSynthesizers = [
            { name: "Moog System 55", freq: 256, type: "Analog", color: "#ff69b4" },
            { name: "Buchla 200e", freq: 288, type: "West Coast", color: "#00ffff" },
            { name: "ARP 2600", freq: 396, type: "Semi-Modular", color: "#9370db" },
            { name: "Roland Jupiter-8", freq: 528, type: "Polysynth", color: "#32cd32" },
            { name: "Prophet-5", freq: 639, type: "Analog", color: "#ff4500" },
            { name: "DX7", freq: 741, type: "FM Synthesis", color: "#1e90ff" },
            { name: "Minimoog", freq: 852, type: "Monophonic", color: "#daa520" },
            { name: "Fairlight CMI", freq: 963, type: "Sampling", color: "#ff1493" }
        ];

        // Sacred Frequencies for Hall of Ateliers
        const sacredFrequencies = {
            "visual-artist": { freq: 528, name: "Love & Transformation", color: "#ff69b4" },
            "mystic": { freq: 852, name: "Spiritual Awakening", color: "#9370db" },
            "researcher": { freq: 741, name: "Intuition & Expression", color: "#00ffff" },
            "scholar": { freq: 741, name: "Intuition & Expression", color: "#00ffff" },
            "designer": { freq: 528, name: "Love & Transformation", color: "#ff69b4" },
            "moonchild": { freq: 288, name: "Will & Power", color: "#32cd32" }
        };

        // Physics Simulation State
        let physicsObjects = [];
        let audioContext = null;
        let currentSynth = null;
        let selectedWorkspace = 'visual-artist';
        let sonicPhysicsActive = false;
        let animationFrame = null;

        // Initialize Interface
        function initializeSonicPhysics() {
            populateSynthesizers();
            createPhysicsObjects();
            setupAudioContext();
            startPhysicsSimulation();
        }

        // Populate Synthesizer Grid
        function populateSynthesizers() {
            const grid = document.getElementById('synthGrid');
            professionalSynthesizers.forEach((synth, index) => {
                const card = document.createElement('div');
                card.className = 'synth-card';
                card.onclick = () => selectSynthesizer(synth, card);
                
                card.innerHTML = `
                    <div class="synth-name">${synth.name}</div>
                    <div class="synth-freq">${synth.freq} Hz</div>
                `;
                
                grid.appendChild(card);
            });
        }

        // Select Synthesizer
        function selectSynthesizer(synth, element) {
            // Remove previous selection
            document.querySelectorAll('.synth-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Select new synthesizer
            element.classList.add('active');
            currentSynth = synth;
            
            // Update frequency display
            document.getElementById('currentFreq').textContent = synth.freq;
            
            // Apply synthesizer to physics
            applySynthToPhysics(synth);
        }

        // Create Physics Objects
        function createPhysicsObjects() {
            const canvas = document.getElementById('physicsCanvas');
            const workspaces = document.querySelectorAll('.workspace-btn');
            
            // Clear existing objects
            canvas.innerHTML = '';
            physicsObjects = [];
            
            // Create objects based on workspace
            const objectCount = selectedWorkspace === 'moonchild' ? 22 : 13; // Moonchild gets 22 objects
            
            for (let i = 0; i < objectCount; i++) {
                const obj = document.createElement('div');
                obj.className = 'physics-sphere';
                obj.style.position = 'absolute';
                obj.style.left = Math.random() * 280 + 'px';
                obj.style.top = Math.random() * 250 + 'px';
                
                // Set size based on frequency
                const size = selectedWorkspace === 'moonchild' ? 
                    'large' : (i % 3 === 0 ? 'medium' : 'small');
                obj.classList.add(size);
                
                // Add interaction
                obj.onclick = () => interactWithObject(obj, i);
                
                canvas.appendChild(obj);
                
                physicsObjects.push({
                    element: obj,
                    x: parseFloat(obj.style.left),
                    y: parseFloat(obj.style.top),
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 0.5) * 4,
                    mass: 1 + (i % 5) * 0.5,
                    frequency: getObjectFrequency(i, objectCount),
                    interacting: false
                });
            }
        }

        // Get Object Frequency
        function getObjectFrequency(index, total) {
            const baseFreq = sacredFrequencies[selectedWorkspace].freq;
            const ratio = (index + 1) / total;
            return Math.round(baseFreq * (0.5 + ratio * 1.5));
        }

        // Interact with Physics Object
        function interactWithObject(obj, index) {
            const physicsObj = physicsObjects[index];
            physicsObj.interacting = true;
            obj.classList.add('interacting');
            
            // Apply audio-physics coupling
            applyAudioPhysicsInteraction(physicsObj);
            
            // Remove interaction after animation
            setTimeout(() => {
                physicsObj.interacting = false;
                obj.classList.remove('interacting');
            }, 500);
        }

        // Apply Audio-Physics Interaction
        function applyAudioPhysicsInteraction(physicsObj) {
            const volumeForce = parseFloat(document.getElementById('volumeForceSlider').value) / 10;
            const freqMass = parseFloat(document.getElementById('freqMassSlider').value) / 10;
            const harmonicsRotation = parseFloat(document.getElementById('harmonicsRotationSlider').value) / 10;
            
            // Apply forces based on audio parameters
            const force = volumeForce * (physicsObj.frequency / 100);
            physicsObj.vx += (Math.random() - 0.5) * force;
            physicsObj.vy -= Math.random() * force;
            
            // Modify mass based on frequency
            physicsObj.mass = 1 + (physicsObj.frequency / 1000) * freqMass;
            
            // Add rotation based on harmonics
            const rotation = harmonicsRotation * (physicsObj.frequency / currentSynth.freq);
            physicsObj.element.style.transform += ` rotate(${rotation}deg)`;
        }

        // Select Workspace
        function selectWorkspace(workspace, element) {
            // Remove previous selection
            document.querySelectorAll('.workspace-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Select new workspace
            element.classList.add('active');
            selectedWorkspace = workspace;
            
            // Update display
            const workspaceData = sacredFrequencies[workspace];
            document.getElementById('currentFreq').textContent = workspaceData.freq;
            document.getElementById('currentWorkspace').textContent = element.textContent.split('\n')[0];
            
            // Recreate physics objects for new workspace
            createPhysicsObjects();
        }

        // Setup Audio Context
        function setupAudioContext() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('Web Audio not supported');
            }
        }

        // Start Physics Simulation
        function startPhysicsSimulation() {
            function updatePhysics() {
                updatePhysicsObjects();
                drawWaveform();
                updateMonitor();
                
                if (sonicPhysicsActive) {
                    animationFrame = requestAnimationFrame(updatePhysics);
                }
            }
            
            if (!animationFrame) {
                updatePhysics();
            }
        }

        // Update Physics Objects
        function updatePhysicsObjects() {
            const gravity = parseFloat(document.getElementById('gravitySlider').value) / 10;
            const bounciness = parseFloat(document.getElementById('bouncinessSlider').value);
            const friction = parseFloat(document.getElementById('frictionSlider').value);
            
            physicsObjects.forEach((obj, index) => {
                // Apply gravity
                obj.vy += gravity;
                
                // Update position
                obj.x += obj.vx;
                obj.y += obj.vy;
                
                // Boundary collision
                const canvas = document.getElementById('physicsCanvas');
                const maxX = canvas.offsetWidth - 60;
                const maxY = canvas.offsetHeight - 60;
                
                if (obj.x <= 0 || obj.x >= maxX) {
                    obj.vx *= -bounciness;
                    obj.x = Math.max(0, Math.min(maxX, obj.x));
                }
                
                if (obj.y <= 0 || obj.y >= maxY) {
                    obj.vy *= -bounciness;
                    obj.y = Math.max(0, Math.min(maxY, obj.y));
                }
                
                // Apply friction
                obj.vx *= (1 - friction * 0.1);
                obj.vy *= (1 - friction * 0.1);
                
                // Update DOM
                obj.element.style.left = obj.x + 'px';
                obj.element.style.top = obj.y + 'px';
            });
        }

        // Draw Waveform
        function drawWaveform() {
            const canvas = document.getElementById('waveformCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw waveform based on current synthesizer
            if (currentSynth) {
                ctx.beginPath();
                ctx.moveTo(0, canvas.height / 2);
                
                for (let x = 0; x < canvas.width; x++) {
                    const time = (x / canvas.width) * Math.PI * 2;
                    const amplitude = Math.sin(time * currentSynth.freq / 100) * canvas.height / 4;
                    const y = canvas.height / 2 + amplitude;
                    ctx.lineTo(x, y);
                }
                
                ctx.strokeStyle = currentSynth.color;
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }

        // Update Monitor
        function updateMonitor() {
            const avgFreq = physicsObjects.reduce((sum, obj) => sum + obj.frequency, 0) / physicsObjects.length;
            document.getElementById('currentFreq').textContent = Math.round(avgFreq);
            document.getElementById('currentAudio').textContent = sonicPhysicsActive ? '85%' : '0%';
        }

        // Engine Control Functions
        function startSonicPhysics() {
            sonicPhysicsActive = true;
            if (!animationFrame) {
                startPhysicsSimulation();
            }
            
            // Play initial tone
            if (currentSynth && audioContext) {
                playFrequency(currentSynth.freq);
            }
        }

        function stopSonicPhysics() {
            sonicPhysicsActive = false;
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
        }

        function syncWithHallOfAteliers() {
            alert(`Syncing with ${selectedWorkspace} workspace...\nOpening Hall of Ateliers with audio-physics integration!`);
            // In real implementation, this would open the 3D Hall of Ateliers
            window.open('../../../hall-of-ateliers/cathedral_3d_hall_of_ateliers.py', '_blank');
        }

        function exportAudioPhysics() {
            const data = {
                workspace: selectedWorkspace,
                synthesizer: currentSynth,
                physicsObjects: physicsObjects.map(obj => ({
                    frequency: obj.frequency,
                    mass: obj.mass,
                    position: { x: obj.x, y: obj.y },
                    velocity: { x: obj.vx, y: obj.vy }
                })),
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sonic-physics-${selectedWorkspace}-${Date.now()}.json`;
            a.click();
        }

        // Play Frequency
        function playFrequency(frequency) {
            if (!audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 1);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 1);
        }

        // Apply Synthesizer to Physics
        function applySynthToPhysics(synth) {
            // Update object frequencies based on synthesizer
            physicsObjects.forEach((obj, index) => {
                obj.frequency = synth.freq + (index * synth.freq * 0.1);
            });
            
            // Recolor objects based on synthesizer
            physicsObjects.forEach(obj => {
                obj.element.style.background = `radial-gradient(circle, ${synth.color}80, ${synth.color}20)`;
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializeSonicPhysics);
    </script>
</body>
</html>