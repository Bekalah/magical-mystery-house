name: ðŸ¤– Gemini Deployment Assistant

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      deployment_target:
        description: 'Deployment target (FREE platforms only: render, surge, coolify, self-host)'
        required: true
        default: 'render'
        type: choice
        options:
          - render
          - surge
          - coolify
          - self-host
      ask_gemini:
        description: 'Ask Gemini for deployment help'
        required: false
        default: true
        type: boolean

jobs:
  gemini-deployment-assistant:
    name: ðŸ¤– Gemini Deployment Assistant
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ðŸ“¦ Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.23.0

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” Analyze deployment context
        id: analyze
        run: |
          echo "DEPLOYMENT_TARGET=${{ github.event.inputs.deployment_target || 'render' }}" >> $GITHUB_OUTPUT
          echo "ASK_GEMINI=${{ github.event.inputs.ask_gemini || 'true' }}" >> $GITHUB_OUTPUT
          
          # Detect what changed
          if [ "${{ github.event_name }}" = "push" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} || echo "")
            echo "CHANGED_FILES<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ¤– Query Gemini for deployment strategy
        if: steps.analyze.outputs.ASK_GEMINI == 'true'
        id: gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          node scripts/gemini-deployment-assistant.mjs \
            --target "${{ steps.analyze.outputs.DEPLOYMENT_TARGET }}" \
            --context "${{ steps.analyze.outputs.CHANGED_FILES }}" \
            --output strategy.json

      - name: ðŸ“‹ Display Gemini recommendations
        if: steps.analyze.outputs.ASK_GEMINI == 'true'
        run: |
          if [ -f strategy.json ]; then
            echo "## ðŸ¤– Gemini Deployment Recommendations" >> $GITHUB_STEP_SUMMARY
            cat strategy.json | jq -r '.recommendations[]' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ Deployment Steps" >> $GITHUB_STEP_SUMMARY
            cat strategy.json | jq -r '.steps[]' >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸš€ Execute deployment (if recommended)
        if: steps.analyze.outputs.ASK_GEMINI == 'true'
        env:
          RENDER_API_TOKEN: ${{ secrets.RENDER_API_TOKEN }}
          SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
          COOLIFY_HOST: ${{ secrets.COOLIFY_HOST }}
          COOLIFY_TOKEN: ${{ secrets.COOLIFY_TOKEN }}
        run: |
          TARGET="${{ steps.analyze.outputs.DEPLOYMENT_TARGET }}"
          
          case "$TARGET" in
            render)
              echo "ðŸš€ Deploying to Render (FREE tier)..."
              ./scripts/deploy-render.sh production || true
              ;;
            surge)
              echo "ðŸš€ Deploying to Surge..."
              pnpm deploy:surge || true
              ;;
            coolify)
              echo "ðŸš€ Deploying to Coolify..."
              ./scripts/deploy-coolify.sh production || true
              ;;
            self-host)
              echo "ðŸš€ Preparing self-host deployment..."
              pnpm build || true
              ;;
          esac

      - name: âœ… Create deployment summary
        run: |
          echo "## âœ… Deployment Assistant Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: ${{ steps.analyze.outputs.DEPLOYMENT_TARGET }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Gemini Assisted**: ${{ steps.analyze.outputs.ASK_GEMINI }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Completed" >> $GITHUB_STEP_SUMMARY

