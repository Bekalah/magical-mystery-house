name: Build and Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      docs-only: ${{ steps.filter.outputs.docs == 'true' }}
      other-files: ${{ steps.filter.outputs.other == 'true' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            docs:
              - 'docs/**'
              - 'README.md'
            other:
              - '**'
              - '!docs/**'
              - '!README.md'

  build:
    needs: check-changes
    # Skip build if ONLY docs changed (deploy-docs.yml handles that)
    # Run if: PR, OR other files changed (even if docs also changed), OR no path filters matched (handles edge cases)
    if: |
      github.event_name == 'pull_request' ||
      needs.check-changes.outputs.other-files == 'true' ||
      (needs.check-changes.outputs.docs-only != 'true' && needs.check-changes.outputs.other-files != 'true')
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: ['25.2']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10.23.0
        run_install: false
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'pnpm'
    
    - name: Get pnpm store directory
      shell: bash
      id: pnpm-store
      run: |
        echo "path=$(pnpm store path --silent)" >> $GITHUB_OUTPUT
    
    - name: Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ${{ steps.pnpm-store.outputs.path }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-
    
    - name: Install dependencies
      run: pnpm install --frozen-lockfile --prefer-offline
      continue-on-error: false
    
    - name: Verify installation
      run: |
        echo "Node version: $(node --version)"
        echo "pnpm version: $(pnpm --version)"
        echo "Checking for node_modules..."
        if [ -d "node_modules" ]; then
          echo "‚úÖ node_modules exists"
          echo "Package count: $(find node_modules -maxdepth 1 -type d | wc -l)"
        else
          echo "‚ùå node_modules not found"
          exit 1
        fi
    
    - name: Run linter
      run: pnpm run lint || true
      continue-on-error: true
    
    - name: Build project
      run: pnpm run build
      continue-on-error: false
    
    - name: Check build output
      run: |
        if [ ! -d "dist" ]; then
          echo "‚ö†Ô∏è  Build warning: dist directory not found"
          echo "Checking for other build outputs..."
          ls -la
        else
          echo "‚úÖ Build successful! dist directory exists"
          echo "Files in dist:"
          find dist -type f | head -10
        fi
    
    - name: Upload build artifacts
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ matrix.node-version }}
        path: |
          dist/
          node_modules/.bin/
        retention-days: 7
        if-no-files-found: warn

  deploy:
    needs: [build, check-changes]
    runs-on: ubuntu-latest
    if: |
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') &&
      needs.check-changes.outputs.other-files == 'true' &&
      (needs.build.result == 'success' || needs.build.result == 'skipped')
    # Use concurrency to prevent race conditions with other workflows
    concurrency:
      group: pages-deployment
      cancel-in-progress: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10.23.0
        run_install: false
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '25.2'
        cache: 'pnpm'
    
    - name: Get pnpm store directory
      shell: bash
      id: pnpm-store
      run: |
        echo "path=$(pnpm store path --silent)" >> $GITHUB_OUTPUT
    
    - name: Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ${{ steps.pnpm-store.outputs.path }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-
    
    - name: Install dependencies
      run: pnpm install --frozen-lockfile --prefer-offline
    
    - name: Build project
      run: pnpm run build
      continue-on-error: false
    
    - name: ü§ñ Get Gemini deployment recommendations
      if: env.GEMINI_API_KEY != ''
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        echo "ü§ñ Getting AI-powered deployment recommendations..."
        node scripts/gemini-deployment-assistant.mjs \
          --target self-host \
          --output gemini-strategy.json || true
        if [ -f gemini-strategy.json ]; then
          echo "## ü§ñ Gemini Deployment Recommendations" >> $GITHUB_STEP_SUMMARY
          cat gemini-strategy.json | jq -r '.recommendations[]? // empty' >> $GITHUB_STEP_SUMMARY || true
        fi
      continue-on-error: true
    
    - name: Copy docs to dist
      run: |
        if [ -d "docs" ]; then
          mkdir -p dist/docs
          cp -r docs/* dist/docs/ || true
          echo "‚úÖ Docs copied to dist/docs"
        else
          echo "‚ö†Ô∏è  Docs directory not found, skipping"
        fi
    
    - name: Deploy to GitHub Pages
      # Note: Concurrency is configured at job level (line 100), not here
      # The peaceiris/actions-gh-pages action does not accept concurrency as a parameter
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        cname: cathedral.bekalah.github.io
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    - name: Create release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/**
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
