# âš—ï¸ Cathedral of Circuits - GitLab CI/CD Pipeline
# Magnum Opus Version 1.0
# Author: Rebecca Respawn
# React + Vite + Turbo Monorepo

stages:
  - setup
  - quality
  - build
  - deploy

variables:
  NODE_VERSION: "20"
  PNPM_VERSION: "10.23.0"
  TURBO_TOKEN: "${CI_JOB_TOKEN}"
  TURBO_TEAM: "bekalah"
  TURBO_REMOTE_CACHE: "true"

# Setup job
setup:
  stage: setup
  image: node:${NODE_VERSION}
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store
  script:
    - pnpm install --frozen-lockfile
    - pnpm --version
    - node --version
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules
    policy: pull
  artifacts:
    paths:
      - node_modules
      - .pnpm-store
    expire_in: 1 hour
  only:
    changes:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"
      - "package.json"
      - "pnpm-lock.yaml"
      - "turbo.json"

# Quality checks
lint:
  stage: quality
  image: node:${NODE_VERSION}
  dependencies:
    - setup
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store
  script:
    - pnpm install --frozen-lockfile --prefer-offline
    - pnpm lint || echo "Linting completed with warnings"
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules
    policy: pull
  allow_failure: true
  only:
    changes:
      - "**/*.ts"
      - "**/*.tsx"
      - "**/*.js"
      - "**/*.jsx"

type-check:
  stage: quality
  image: node:${NODE_VERSION}
  dependencies:
    - setup
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store
  script:
    - pnpm install --frozen-lockfile --prefer-offline
    - pnpm type-check || echo "Type checking completed with warnings"
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules
    policy: pull
  allow_failure: true

# Build all apps with Turbo
build:
  stage: build
  image: node:${NODE_VERSION}
  dependencies:
    - setup
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store
  script:
    - pnpm install --frozen-lockfile --prefer-offline
    - pnpm build
    - |
      echo "Build outputs:"
      find . -type d -name "dist" -o -name "build" -o -name ".next" | head -20
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules
    policy: pull
  artifacts:
    paths:
      - apps/*/dist
      - apps/*/build
      - packages/*/dist
      - packages/*/build
    expire_in: 1 week
    when: on_success
  only:
    - main
    - master
    - merge_requests

# Build individual apps (for Coolify/Surge)
build:web:
  stage: build
  image: node:${NODE_VERSION}
  dependencies:
    - setup
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - pnpm config set store-dir .pnpm-store
  script:
    - pnpm install --frozen-lockfile --prefer-offline
    - pnpm turbo build --filter=apps/web
    - |
      echo "Web app build complete"
      if [ -d "apps/web/dist" ]; then
        echo "âœ… dist directory exists"
        ls -la apps/web/dist
      fi
  cache:
    key:
      files:
        - pnpm-lock.yaml
    paths:
      - .pnpm-store
      - node_modules
    policy: pull
  artifacts:
    paths:
      - apps/web/dist
    expire_in: 1 week
    when: on_success
  only:
    - main
    - master
    changes:
      - "apps/web/**/*"
      - "packages/**/*"
      - "package.json"
      - "pnpm-lock.yaml"
      - "turbo.json"

# Deploy to Surge (Free static hosting)
deploy:surge:
  stage: deploy
  image: node:${NODE_VERSION}
  dependencies:
    - build:web
  before_script:
    - corepack enable
    - corepack prepare pnpm@${PNPM_VERSION} --activate
    - npm install -g surge
  script:
    - |
      if [ -d "apps/web/dist" ]; then
        cd apps/web/dist
        surge . "${SURGE_DOMAIN}" --token "${SURGE_TOKEN}"
      else
        echo "âŒ dist directory not found"
        exit 1
      fi
  environment:
    name: production/surge
    url: https://${SURGE_DOMAIN}
  only:
    - main
    - master
  when: manual
  variables:
    SURGE_DOMAIN: "cathedral-of-circuits.surge.sh"
    SURGE_TOKEN: "${SURGE_TOKEN}"

# Deploy to Coolify (Self-hosted PaaS)
deploy:coolify:
  stage: deploy
  image: node:${NODE_VERSION}
  dependencies:
    - build:web
  before_script:
    - apk add --no-cache curl git openssh
    - mkdir -p ~/.ssh
    - echo "${COOLIFY_SSH_PRIVATE_KEY}" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H ${COOLIFY_HOST} >> ~/.ssh/known_hosts
  script:
    - |
      if [ -d "apps/web/dist" ]; then
        echo "âœ… Build artifacts ready for Coolify"
        echo "Deploy directory: apps/web/dist"
        ls -la apps/web/dist
      else
        echo "âŒ dist directory not found"
        exit 1
      fi
    # Coolify deployment via Git push or webhook
    # Adjust based on your Coolify setup
  environment:
    name: production/coolify
    url: https://${COOLIFY_DOMAIN}
  only:
    - main
    - master
  when: manual
  variables:
    COOLIFY_HOST: "${COOLIFY_HOST}"
    COOLIFY_DOMAIN: "${COOLIFY_DOMAIN}"

# Archive old workflow file
archive:github-actions:
  stage: deploy
  image: alpine:latest
  script:
    - |
      if [ -d ".github/workflows" ]; then
        echo "ðŸ“¦ Archiving GitHub Actions workflows"
        mkdir -p archive/github-workflows
        mv .github/workflows/* archive/github-workflows/ 2>/dev/null || true
        echo "âœ… GitHub workflows archived"
      fi
  artifacts:
    paths:
      - archive/github-workflows
    expire_in: 1 month
  only:
    - main
    - master
  when: manual
